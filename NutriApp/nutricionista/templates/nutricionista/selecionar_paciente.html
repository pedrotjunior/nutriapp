{% extends "base_nutricionista.html" %}
{% block content %}

<div id="custom-alert" class="custom-alert">
    <span id="alert-message"></span>
</div>
<div class="box-central">
    <div class="caixa-titulo">
        <h2>Selecionar Paciente</h2>
    </div>

    <div class="text-center mb-3">
        <p class="m-0">
            Paciente selecionado:
            <strong id="paciente-selecionado">
                {% if paciente_selecionado %}
                    {{ paciente_selecionado }}
                {% else %}
                    Nenhum
                {% endif %}
            </strong>
        </p>
    </div>

    <!-- Campo suspenso de sele√ß√£o com √≠cone -->
    <div class="campo-pesquisa">
        <div class="dropdown-container">
            <input type="text" id="input-paciente" placeholder="Clique para selecionar um paciente..." readonly>
            <span class="dropdown-arrow">‚ñº</span>
        </div>

        <div id="lista-pacientes" class="lista-suspensa">
            {% for paciente in pacientes|dictsort:"nome" %}
                <div class="paciente-item"
                     data-id="{{ paciente.id }}"
                     data-nome="{{ paciente.nome }}">
                    {{ paciente.nome }}
                </div>
            {% endfor %}
        </div>
    </div>
    <br>    
    <div class="caixa-menu-link">
        <div>
            <a id="link-antropometria" href="#" class="btn btn-success">
                Medidas Antropom√©tricas
            </a> 
            <a id="link-registro-alimentar" href="#" class="btn btn-success">
                registro alimentar
            </a>
        </div>
        <div>
            <a id="link-resultados-medidas" href="#" class="btn btn-secondary">
                Resultados das Medidas
            </a>
            <a id="link-aspectos_clinicos" href="#" class="btn btn-success">
                Aspectos Clinicos
            </a>
        </div>
        <div>
            <a id="link-avaliacao_estilo_vida" href="#" class="btn btn-success">
                Avaliacao Estilo de Vida
            </a>
            <a id="link-cadastrar_frequencia" href="#" class="btn btn-secondary">
                Cadastrar Frequencia
            </a>
        </div>
        <div>
            <a id="link-medicamento" href="#" class="btn btn-success">
                Medicamento
            </a>
        </div>
    </div>
    <br>
    <button id="btn-encerrar-consulta" class="btn btn-danger mt-3">
    Encerrar Consulta
</button>
</div>

<script>
const AVALIACAO_URL_BASE = '/nutricionista/avaliacao/';
const PACIENTE_URL_BASE = '/nutricionista/paciente/';

function showTimedAlert(message) {
    const alertBox = document.getElementById('custom-alert');
    const alertMessage = document.getElementById('alert-message');
    if (!alertBox || !alertMessage) return;

    alertMessage.textContent = message;
    alertBox.style.display = 'block';
    alertBox.classList.add('visible');

    setTimeout(() => {
        alertBox.classList.remove('visible');
        setTimeout(() => {
            alertBox.style.display = 'none';
        }, 300);
    }, 3000);
}

function clearPatientSelection() {
    const pacienteLabel = document.getElementById('paciente-selecionado');
    if (pacienteLabel) pacienteLabel.textContent = "Nenhum";

    const links = [
        'link-antropometria', 'link-registro-alimentar', 'link-resultados-medidas',
        'link-aspectos_clinicos', 'link-avaliacao_estilo_vida',
        'link-cadastrar_frequencia', 'link-medicamento'
    ];
    links.forEach(id => {
        const link = document.getElementById(id);
        if (link) link.href = "#";
    });
}

function setActionLinks(pacienteId) {
    const map = {
        'link-antropometria': `${AVALIACAO_URL_BASE}${pacienteId}/`,
        'link-resultados-medidas': `${PACIENTE_URL_BASE}${pacienteId}/resultados_medidas/`,
        'link-registro-alimentar': `${PACIENTE_URL_BASE}${pacienteId}/registro-alimentar/`,
        'link-aspectos_clinicos': `${PACIENTE_URL_BASE}${pacienteId}/aspectos-clinicos/`,
        'link-avaliacao_estilo_vida': `${PACIENTE_URL_BASE}${pacienteId}/avaliacao-estilo-vida/`,
        'link-cadastrar_frequencia': `${PACIENTE_URL_BASE}${pacienteId}/frequencia-alimentar/`,
        'link-medicamento': `${PACIENTE_URL_BASE}${pacienteId}/medicamentos/`
    };
    for (const [id, url] of Object.entries(map)) {
        const el = document.getElementById(id);
        if (el) el.href = url;
    }
}

document.addEventListener("DOMContentLoaded", async function() {
    const input = document.getElementById("input-paciente");
    const lista = document.getElementById("lista-pacientes");
    const container = document.querySelector(".dropdown-container");
    const pacienteSelecionado = document.getElementById("paciente-selecionado");
    const encerrarBtn = document.getElementById("btn-encerrar-consulta");
    
    const sessaoResponse = await fetch("{% url 'nutricionista:obter_paciente_sessao' %}");
    const sessaoData = await sessaoResponse.json();

    if (sessaoData.paciente_id) {
        pacienteSelecionado.textContent = sessaoData.paciente_nome;
        input.value = sessaoData.paciente_nome;
        setActionLinks(sessaoData.paciente_id);
    } else {
        clearPatientSelection();
        setTimeout(() => showTimedAlert("Selecione um paciente para continuar."), 500);
    }

    // abre/fecha lista e anima seta
    input.addEventListener("click", () => {
        const isOpen = lista.style.display === "block";
        lista.style.display = isOpen ? "none" : "block";
        container.classList.toggle("open", !isOpen);
    });

    // seleciona paciente
    lista.addEventListener("click", async (e) => {
    if (e.target.classList.contains("paciente-item")) {
        const nome = e.target.dataset.nome;
        const id = e.target.dataset.id;

        pacienteSelecionado.textContent = nome;
        input.value = nome;
        lista.style.display = "none";
        container.classList.remove("open");
        setActionLinks(id);

       // üîπ Salvar paciente na sess√£o
        await fetch("{% url 'nutricionista:salvar_paciente_sessao' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: `paciente_id=${id}`
        });
            }
});

    // fecha lista ao clicar fora
    document.addEventListener("click", (e) => {
        if (!e.target.closest(".campo-pesquisa")) {
            lista.style.display = "none";
            container.classList.remove("open");
        }
    });

    // bloqueia bot√µes sem paciente
    const actionLinks = [
        'link-antropometria', 'link-registro-alimentar', 'link-resultados-medidas',
        'link-aspectos_clinicos', 'link-avaliacao_estilo_vida',
        'link-cadastrar_frequencia', 'link-medicamento'
    ].map(id => document.getElementById(id)).filter(Boolean);

    actionLinks.forEach(link => {
        link.addEventListener("click", (e) => {
            if (link.href.endsWith("#")) {
                e.preventDefault();
                showTimedAlert("Selecione um paciente para continuar.");
            }
        });
    });
    if (encerrarBtn) {
        encerrarBtn.addEventListener("click", async () => {
            const response = await fetch("{% url 'nutricionista:encerrar_consulta' %}", {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}" },
            });
            const data = await response.json();

            if (data.status === "ok") {
                input.value = "";
                pacienteSelecionado.textContent = "Nenhum";
                clearPatientSelection();
                alert("Consulta encerrada.");
            }
        });
    }
});
</script>
{% endblock content %}