{% extends "base_paciente.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Resultados das Medidas</h2>

    {# ==== Comparação de Peso ==== #}
    {% if comparacao_peso %}
        <div class="card mb-4 p-3 border-{{ comparacao_peso.cor|default:'secondary' }}">
            <h4 class="{{ comparacao_peso.cor|default:'text-secondary' }}">
                {{ comparacao_peso.mensagem }}
            </h4>
            <p class="m-0">
                Peso Inicial: <strong>{{ comparacao_peso.primeiro_peso|floatformat:2|default:"N/A" }} kg</strong>
                | Peso Atual: <strong>{{ comparacao_peso.ultimo_peso|floatformat:2|default:"N/A" }} kg</strong>
            </p>
        </div>
    {% endif %}

    {# ==== Tabela de Comparação de Medidas ==== #}
    <div class="row">
        <div class="col-md-12">
            <h3 class="mt-4 mb-3">Comparação de Medidas (Penúltima vs. Última Consulta)</h3>

            {% if dados_medidas %}
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Medida</th>
                            <th>Primeira ({{ data_primeira|date:"d/m/Y" }})</th>
                            {% if possui_duas_consultas %}
                                <th>Última ({{ data_ultima|date:"d/m/Y" }})</th>
                            {% else %}
                                <th>Próxima Consulta</th>
                            {% endif %}
                            <th>Resultado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for dado in dados_medidas %}
                        <tr>
                            <td><strong>{{ dado.nome }}</strong></td>
                            <td>{{ dado.penultimo_valor|floatformat:2|default:"N/A" }}</td>
                            <td>{{ dado.ultimo_valor|floatformat:2|default:"N/A" }}</td>
                            <td class="{{ dado.cor }}"><strong>{{ dado.mensagem }}</strong></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="alert alert-info">Nenhum registro de consulta encontrado para este paciente.</p>
            {% endif %}
        </div>
    </div>

    {# ==== Gráfico de Evolução ==== #}
    <div class="mt-5">
        <h4 class="text-center mb-4">Evolução do Peso e da Cintura</h4>
        {% if tem_dados %}
            <canvas id="graficoEvolucao" height="120"></canvas>
        {% else %}
            <p class="text-center text-muted">Ainda não há dados suficientes para gerar o gráfico.</p>
        {% endif %}
    </div>
</div>

{# ==== Chart.js ==== #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% if tem_dados %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const ctx = document.getElementById('graficoEvolucao').getContext('2d');

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ datas_json|safe }},
            datasets: [
                {
                    label: 'Peso (kg)',
                    data: {{ pesos_json|safe }},
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.3
                },
                {
                    label: 'Circunferência da Cintura (cm)',
                    data: {{ cinturas_json|safe }},
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: false }
            }
        }
    });
});
</script>
{% endif %}

{% endblock %}
